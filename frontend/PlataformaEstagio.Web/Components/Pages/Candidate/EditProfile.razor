@page "/candidato/perfil/editar"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@using PlataformaEstagio.Web.Components.Services.Candidate
@using PlataformaEstagios.Communication
@inject ICandidateService CandidateService
@inject IUserContext CurrentUser
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.False" Class="px-6 py-4">
    <!-- HERO -->
    <MudPaper Class="hero-card mb-4" Elevation="0">
        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="hero-inner">
            <MudIcon Icon="@Icons.Material.Outlined.Edit" Size="Size.Large" />
            <MudText Typo="Typo.h5" Class="font-bold">Editar Perfil</MudText>
        </MudStack>
    </MudPaper>

    <MudPaper Class="px-4 py-4 elev">

        @if (!_hydrated)
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-6">
                <MudProgressCircular Indeterminate="true" />
                <MudText Color="Color.Secondary">Inicializando...</MudText>
            </MudStack>
        }
        else if (!_loaded)
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-6">
                <MudProgressCircular Indeterminate="true" />
                <MudText Color="Color.Secondary">Carregando perfil...</MudText>
            </MudStack>
        }
        else
        {
            <MudForm @ref="_form" Disabled="_busy">

                <!-- Seção: Dados básicos -->
                <div class="section">
                    <div class="section__title">
                        <MudIcon Icon="@Icons.Material.Outlined.Badge" />
                        <MudText Typo="Typo.subtitle1" Class="font-medium">Dados básicos</MudText>
                    </div>

                    <MudGrid GutterSize="GutterSize.Small">
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_vm.FullName" Label="Nome*" Required="true"
                                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.Person" />
                        </MudItem>

                        <MudItem xs="12" md="3">
                            <MudDatePicker @bind-Date="_vm.BirthDate" Label="Data de Nascimento" />
                        </MudItem>

                        <MudItem xs="12" md="12">
                            <MudTextField @bind-Value="_vm.BioResume" Lines="4" Label="Resumo"
                                          HelperText="Breve apresentação sobre você" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_vm.Course" Label="Curso"
                                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.School" />
                        </MudItem>
                    </MudGrid>
                </div>

                <!-- Seção: Endereço -->
                <div class="section">
                    <div class="section__title">
                        <MudIcon Icon="@Icons.Material.Outlined.HomeWork" />
                        <MudText Typo="Typo.subtitle1" Class="font-medium">Endereço</MudText>
                    </div>

                    <MudGrid GutterSize="GutterSize.Small">
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_vm.Address.Street" Label="Rua" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_vm.Address.Complement" Label="Complemento" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_vm.Address.Neighborhood" Label="Bairro" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_vm.Address.City" Label="Cidade" />
                        </MudItem>
                        <MudItem xs="6" md="3">
                            <MudTextField @bind-Value="_vm.Address.Uf" Label="UF" MaxLength="2" />
                        </MudItem>
                        <MudItem xs="6" md="3">
                            <MudTextField @bind-Value="_vm.Address.Cep" Label="CEP"
                                          Mask="@(new PatternMask("00000-000"))" MaskChar="_" InputMode="InputMode.text" />
                        </MudItem>
                    </MudGrid>
                </div>

                <!-- Seção: Arquivos -->
                <div class="section">
                    <div class="section__title">
                        <MudIcon Icon="@Icons.Material.Outlined.AttachFile" />
                        <MudText Typo="Typo.subtitle1" Class="font-medium">Arquivos</MudText>
                    </div>

                    <MudGrid GutterSize="GutterSize.Small">
                        <!-- Foto -->
                        <MudItem xs="12" md="6">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body2" Class="font-medium">Foto de Perfil</MudText>
                                <InputFile OnChange="OnPhotoSelected" accept="image/jpeg,image/png,image/webp" />
                                <MudText Typo="Typo.caption" Class="text-dim">Formatos: JPEG/PNG/WEBP. Máx 5MB.</MudText>

                                @if (!string.IsNullOrWhiteSpace(_imagePreview) || !string.IsNullOrWhiteSpace(_currentPublicPhoto))
                                {
                                    <MudPaper Class="preview-card" Elevation="1">
                                        <img src="@(_imagePreview ?? _currentPublicPhoto)" alt="Foto" class="preview-img" />
                                    </MudPaper>
                                }
                            </MudStack>
                        </MudItem>

                        <!-- Currículo -->
                        <MudItem xs="12" md="6">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body2" Class="font-medium">Currículo (PDF)</MudText>
                                <InputFile OnChange="OnResumeSelected" accept="application/pdf" />
                                <MudText Typo="Typo.caption" Class="text-dim">Apenas PDF. Máx 5MB.</MudText>

                                @if (!string.IsNullOrWhiteSpace(_resumeSelectedName))
                                {
                                    <MudAlert Severity="Severity.Info" Class="mt-1" Elevation="0">
                                        PDF anexado: @_resumeSelectedName
                                    </MudAlert>
                                }

                                @if (!string.IsNullOrWhiteSpace(_currentPublicResume))
                                {
                                    <MudPaper Class="preview-card row" Elevation="1">
                                        <MudIcon Icon="@Icons.Material.Filled.PictureAsPdf" />
                                        <MudLink Href="@_currentPublicResume" Target="_blank" Rel="noopener">
                                            Ver currículo (PDF)
                                        </MudLink>
                                    </MudPaper>
                                }
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </div>

                <!-- Ações -->
                <div class="actions">
                    <MudStack Row Spacing="2" Justify="Justify.FlexStart" AlignItems="AlignItems.Center">
                        <MudButton Color="Color.Primary" OnClick="SaveAsync" Disabled="_busy">
                            @if (_busy)
                            {
                                <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                            }
                            Salvar
                        </MudButton>

                        <MudButton Variant="Variant.Text" Disabled="_busy"
                                   OnClick="@(() => Nav.NavigateTo("/candidato/home"))">
                            Cancelar
                        </MudButton>
                    </MudStack>
                </div>

            </MudForm>
        }
    </MudPaper>
</MudContainer>

<style>
    /* Hero da página */
    .hero-card {
        border: 1px solid var(--mud-palette-divider);
        border-radius: 14px;
        background: radial-gradient(900px 220px at 0% -30%, color-mix(in oklab, var(--mud-palette-primary) 12%, transparent) 0%, transparent 60%), var(--mud-palette-surface);
    }

    .hero-inner {
        padding: 16px 18px;
    }

    .font-medium {
        font-weight: 600;
    }

    .text-dim {
        color: var(--mud-palette-text-secondary);
    }

    /* Paper principal */
    .elev {
        border: 1px solid var(--mud-palette-divider);
        border-radius: 14px;
    }

    /* Título de seção com barra lateral e tint, no mesmo estilo dos cards */
    .section {
        margin-bottom: 22px;
    }

    .section__title {
        position: relative;
        display: flex;
        align-items: center;
        gap: .5rem;
        padding: 10px 14px 10px 20px;
        border: 1px solid var(--mud-palette-divider);
        border-radius: 10px;
        margin-bottom: 10px;
    }

        .section__title::before {
            content: "";
            position: absolute;
            inset: 0 auto 0 0;
            width: 6px;
            border-radius: 10px 0 0 10px;
            background: linear-gradient(180deg, color-mix(in oklab, var(--mud-palette-primary) 92%, white 8%), color-mix(in oklab, var(--mud-palette-primary) 62%, white 38%));
        }

        .section__title .mud-typography {
            font-weight: 700;
            color: var(--mud-palette-text-primary);
        }

        .section__title .mud-icon-root {
            color: var(--mud-palette-primary);
            opacity: .95;
        }

    /* Previews (foto/pdf) */
    .preview-card {
        display: flex;
        align-items: center;
        gap: .6rem;
        padding: 8px 10px;
        border: 1px solid var(--mud-palette-divider);
        border-radius: 10px;
        width: fit-content;
        background: var(--mud-palette-surface);
    }

        .preview-card.row {
            flex-direction: row;
        }

    .preview-img {
        max-width: 220px;
        border-radius: 8px;
        display: block;
    }

    /* Barra de ações no rodapé do form */
    .actions {
        padding-top: 10px;
        border-top: 1px dashed var(--mud-palette-divider);
    }

    /* Responsivo */
    @@media (max-width: 599px) {
        .hero-inner

    {
        padding: 12px;
    }

    }
</style>


@code {
    private MudForm? _form;
    private bool _busy;
    private bool _loaded;
    private bool _hydrated;

    private Guid _candidateId;

    private readonly long MaxImageBytes = 5 * 1024 * 1024;
    private readonly long MaxPdfBytes = 5 * 1024 * 1024;

    private EditVm _vm = new();
    private string? _imagePreview;        // data URI
    private string? _resumeSelectedName;  // exibição
    private string? _currentPublicPhoto;  // ProfilePicturePath do GET
    private string? _currentPublicResume;  // ProfilePicturePath do GET

    protected override Task OnInitializedAsync() => Task.CompletedTask;
    private const string ApiPublicBase = "https://localhost:7095"; // ajuste p/ seu ambiente

    private static string? ToAbsolute(string? path)
    {
        if (string.IsNullOrWhiteSpace(path)) return null;
        if (path.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return path;
        var p = path.StartsWith("/") ? path : "/" + path;
        return $"{ApiPublicBase.TrimEnd('/')}{p}";
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hydrated && firstRender)
        {
            _hydrated = true;

            await CurrentUser.RefreshAsync(); // hidrata token/claims

            if (!CurrentUser.IsAuthenticated)
            {
                Snackbar.Add("Sessão expirada. Faça login novamente.", Severity.Error);
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            // Seu padrão: CandidateId fica em UserTypeId quando Role = Candidate
            if (CurrentUser.UserTypeId is Guid cid && cid != Guid.Empty)
                _candidateId = cid;
            else
            {
                Snackbar.Add("ID do candidato não encontrado nas claims.", Severity.Error);
                Nav.NavigateTo("/candidato/home");
                return;
            }

            await LoadAsync();
            _loaded = true;
            StateHasChanged();
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            var dto = await CandidateService.GetByIdAsync(_candidateId);
            _vm.FullName = dto.FullName;
            _vm.BirthDate = dto.BirthDate;
            _vm.Course = dto.CourseName;
            _vm.Address = dto.Address ?? new AddressDto();
            _vm.BioResume = dto.BioResume;
            _currentPublicPhoto = ToAbsolute(dto.ProfilePicturePath); // só para exibir
            _currentPublicResume = ToAbsolute(dto.ResumePath); // só para exibir
            _imagePreview = null;       // limpa preview local
            _resumeSelectedName = null;       // limpa label do PDF
            _vm.ProfilePictureBase64 = null;    // NÃO reenvia caminho como se fosse base64
            _vm.ResumeBase64 = null;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Falha ao carregar perfil: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnPhotoSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file is null) return;

            var ct = file.ContentType?.ToLowerInvariant();
            if (ct is not ("image/jpeg" or "image/png" or "image/webp"))
            {
                Snackbar.Add("Imagem inválida. Use JPEG/PNG/WEBP.", Severity.Warning);
                return;
            }
            if (file.Size > MaxImageBytes)
            {
                Snackbar.Add("Imagem muito grande (máx 5MB).", Severity.Warning);
                return;
            }

            using var s = file.OpenReadStream(MaxImageBytes);
            using var ms = new MemoryStream();
            await s.CopyToAsync(ms);
            var b64 = Convert.ToBase64String(ms.ToArray());
            _imagePreview = $"data:{file.ContentType};base64,{b64}";

            // Prepara para envio
            _vm.ProfilePictureBase64 = _imagePreview;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Falha ao processar a imagem: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnResumeSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file is null) return;

            if (!string.Equals(file.ContentType, "application/pdf", StringComparison.OrdinalIgnoreCase))
            {
                Snackbar.Add("Anexe apenas PDF.", Severity.Warning);
                return;
            }
            if (file.Size > MaxPdfBytes)
            {
                Snackbar.Add("PDF muito grande (máx 5MB).", Severity.Warning);
                return;
            }

            using var s = file.OpenReadStream(MaxPdfBytes);
            using var ms = new MemoryStream();
            await s.CopyToAsync(ms);
            var b64 = Convert.ToBase64String(ms.ToArray());
            _vm.ResumeBase64 = $"data:application/pdf;base64,{b64}";
            _resumeSelectedName = file.Name;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Falha ao processar o PDF: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveAsync()
    {
        await _form!.Validate();

        // Validações mínimas front (backend segue validando)
        if (string.IsNullOrWhiteSpace(_vm.FullName))
        {
            Snackbar.Add("Nome é obrigatório.", Severity.Warning);
            return;
        }
        if (!string.IsNullOrWhiteSpace(_vm.Address?.Uf) && _vm.Address!.Uf!.Length != 2)
        {
            Snackbar.Add("UF deve ter 2 letras.", Severity.Warning); return;
        }
        if (!string.IsNullOrWhiteSpace(_vm.Address?.Cep) && _vm.Address!.Cep!.Length != 9)
        {
            Snackbar.Add("CEP deve ter 8 dígitos (apenas números).", Severity.Warning); return;
        }

        _busy = true;
        try
        {
            var payload = new RequestUpdateCandidateProfileJson
            {
                FullName = _vm.FullName,
                BirthDate = _vm.BirthDate,
                Course = _vm.Course,
                BioResume = _vm.BioResume,
                Address = _vm.Address,
                ProfilePictureBase64 = _vm.ProfilePictureBase64, // null se não trocou
                ResumeBase64 = _vm.ResumeBase64                  // null se não anexou
            };

            var (ok, err) = await CandidateService.UpdateProfileAsync(_candidateId, payload);
            if (!ok)
            {
                Snackbar.Add(string.IsNullOrWhiteSpace(err) ? "Falha ao atualizar o perfil." : err, Severity.Error);
                return;
            }
            Snackbar.Add("Perfil atualizado com sucesso!", Severity.Success);

            // evita reenvio desnecessário no próximo PUT
            _vm.ProfilePictureBase64 = null;
            _vm.ResumeBase64 = null;
            _imagePreview = null;
            _resumeSelectedName = null;

            // reload para pegar caminho público novo
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _busy = false;
        }
    }

    private sealed class EditVm
    {
        public string? FullName { get; set; }
        public DateTime? BirthDate { get; set; }
        public string? BioResume { get; set;  }
        public string? Course { get; set; }
        public AddressDto Address { get; set; } = new();
        public string? ProfilePictureBase64 { get; set; }
        public string? ResumeBase64 { get; set; }
    }
}
