@page "/"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.WebUtilities
@using MudBlazor
@using PlataformaEstagios.Communication.Requests
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject PlataformaEstagio.Web.Components.Services.Auth.IAuthService Auth
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedSessionStorage Session;

<section class="auth-hero">
    <MudContainer MaxWidth="MaxWidth.Large">
        <MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center">
            <MudItem xs="12" sm="8" md="6" lg="5">
                <MudPaper Class="auth-card" Elevation="2">
                    <MudStack Spacing="2">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Class="title">Bem-vindo ao StartCarreira</MudText>
                            <MudText Typo="Typo.body2" Class="subtitle">
                                Acesse sua conta para acompanhar vagas e candidaturas.
                            </MudText>
                        </MudStack>

                        <EditForm Model="_model" OnValidSubmit="HandleLogin">
                            <MudStack Spacing="2">
                                <MudTextField @bind-Value="_model.EmailOrNickname"
                                              For="@(() => _model.EmailOrNickname)"
                                              Label="Usuário ou e-mail"
                                              Required="true" Immediate="true"
                                              FullWidth="true" />

                                <!-- Mostrar/ocultar senha com ícone no AdornmentEnd -->
                                <MudTextField @bind-Value="_model.Password"
                                              For="@(() => _model.Password)"
                                              Label="Senha"
                                              InputType="@(_showPassword? InputType.Text: InputType.Password)"
                                              Required="true" Immediate="true"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@(_showPassword? Icons.Material.Outlined.VisibilityOff : Icons.Material.Outlined.Visibility)"
                                              OnAdornmentClick="@TogglePassword"
                                              AdornmentAriaLabel="Mostrar/ocultar senha"
                                              FullWidth="true"
                                              AdornmentIconColor="Color.Default" />


                                <!-- Botão principal com spinner durante o submit -->
                                <MudButton ButtonType="ButtonType.Submit"
                                           Disabled="_isSubmitting"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           Class="submit-btn"
                                           FullWidth="true">
                                    @if (_isSubmitting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Class="mr-1" Indeterminate="true" />
                                    }
                                    @(_isSubmitting ? "Entrando..." : "Entrar")
                                </MudButton>

                                <!-- Ações secundárias SSO/LGN (sem lógica, apenas UI) -->
                                <MudStack Spacing="1">
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Outlined.AccountCircle"
                                               FullWidth="true"
                                               Disabled="true"
                                               Title="Em breve">
                                        Entrar com Google
                                    </MudButton>

                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Secondary"
                                               StartIcon="@Icons.Custom.Brands.GitHub"
                                               FullWidth="true"
                                               Disabled="true"
                                               Title="Em breve">
                                        Entrar com GitHub
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </EditForm>

                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.body2" Class="signup">
                            Não possui cadastro?
                            <MudLink Href="/Register">Cadastre-se</MudLink>
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
</section>

<style>
    .auth-hero{
        padding-top: clamp(24px, 8vh, 64px);
        padding-bottom: clamp(24px, 10vh, 96px);
    }
    .auth-card{
        padding: clamp(20px, 3.2vw, 32px);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 16px;
        background: var(--mud-palette-surface);
    }
    .title{
        font-weight: 700;
        letter-spacing: .2px;
    }
    .subtitle{
        color: var(--mud-palette-text-secondary);
        margin-top: 2px;
    }
    .submit-btn{
        margin-top: 6px;
        height: 42px;
        font-weight: 600;
        letter-spacing: .3px;
    }
    .signup{
        color: var(--mud-palette-text-secondary);
    }
    @@media (max-width: 599px){
        .auth-card{ padding: 18px; }
    }
</style>


@code {
    private MudForm? _form;
    private bool _isSubmitting;
    const string TokenKey = "auth.token";
    const string SessionKey = "auth.session";
    private RequestLoginJson _model = new();

    // ADD: estado local para mostrar/ocultar senha
    private bool _showPassword;
    private void TogglePassword() => _showPassword = !_showPassword;


    private async Task HandleLogin()
    {
        if (_isSubmitting) return;
        _isSubmitting = true;
        try
        {
            var ok = await Auth.LoginAsync(_model);
            if (!ok)
            {
                Snackbar.Add("Usuário ou senha inválidos.", Severity.Error);
                return;
            }

            // 1) Se vem de uma rota protegida, volte pra ela:
            if (TryGetReturnUrl(out var returnUrl))
            {
                Nav.NavigateTo(returnUrl);
            }

            // 2) Caso contrário, vá para a home conforme tipo:
            var session = await Auth.GetSessionAsync();
            switch (session?.UserType.ToString())
            {
                case "Candidate":
                    Nav.NavigateTo("/candidato/home");
                    break;
                case "Enterprise":
                    Nav.NavigateTo("/empresa/home");
                    break;
                default:
                    Nav.NavigateTo("/");
                    break;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro inesperado: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }
    private bool TryGetReturnUrl(out string url)
    {
        var uri = new Uri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("returnUrl", out var val))
        {
            var candidate = val.ToString();
            if (Uri.IsWellFormedUriString(candidate, UriKind.Relative))
            {
                url = candidate;
                return true;
            }
        }
        url = default!;
        return false;
    }
}
