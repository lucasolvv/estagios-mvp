@page "/empresa/candidatura/gerenciar/{applicationId:guid}/{candidateId:guid}"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Web
@using PlataformaEstagio.Web.Components.Services.Enterprise
@using PlataformaEstagio.Web.Components.Services.Candidate
@using PlataformaEstagio.Web.Components.Services.Auth
@using PlataformaEstagios.Communication.Requests
@using PlataformaEstagios.Communication.Responses
@using PlataformaEstagios.Domain.Enums
@inject IEnterpriseService EnterpriseService
@inject IUserContext CurrentUser
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.False" Class="px-6 py-4">

    <!-- HERO -->
    <MudPaper Class="hero-card elev mb-4">
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="hero-inner">
            <MudStack Spacing="1">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.ManageAccounts" />
                    <MudText Typo="Typo.h5" Class="font-bold">Gerenciar candidatura</MudText>
                </MudStack>
                <MudText Typo="Typo.subtitle2" Class="text-dim">
                    Visualize o perfil do candidato, atualize o status e agende entrevistas.
                </MudText>
            </MudStack>

            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(()=> Nav.NavigateTo("/empresa/home"))">
                Voltar
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (!_loaded)
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="320px" />
    }
    else if (_notFound)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense>
            Candidatura não encontrada ou você não tem acesso.
        </MudAlert>
    }
    else
    {
        <MudGrid>

            <!-- Coluna esquerda: Candidato -->
            <MudItem xs="12" md="4">
                <MudCard Class="elev">
                    <div class="card-header accent-info">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Person" />
                            <MudText Typo="Typo.subtitle1">Candidato</MudText>
                        </MudStack>
                    </div>

                    <MudCardContent Class="pa-4">
                        <MudStack Spacing="2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Size="Size.Large" Image="@_vm.Candidate.ProfilePictureUrl" Color="Color.Primary"> @if (string.IsNullOrEmpty(@_vm.Candidate.ProfilePictureUrl)) {
                                @(_vm.Candidate.Initials)
                                    } else
                                    {

                                <MudImage Src="@_vm.Candidate.ProfilePictureUrl"></MudImage>
                            }
                                </MudAvatar>
                                <MudStack>
                                    <MudText Typo="Typo.subtitle1" Class="font-bold">@_vm.Candidate.FullName</MudText>
                                    <MudText Typo="Typo.caption" Class="text-dim">
                                        @_vm.Candidate.Course @(_vm.Candidate.Semester is null ? "" : $" • {_vm.Candidate.Semester}º período")
                                    </MudText>
                                </MudStack>
                            </MudStack>

                            <MudList Dense="true" Class="list-clean" T="string">
                                <MudListItem>
                                    <MudListItemIcon><MudIcon Icon="@Icons.Material.Filled.LocationOn" /></MudListItemIcon>
                                    <MudListItemText>@_vm.Candidate.City - @_vm.Candidate.UF</MudListItemText>
                                </MudListItem>
                                <MudListItem>
                                    <MudListItemIcon><MudIcon Icon="@Icons.Material.Filled.Email" /></MudListItemIcon>
                                    <MudListItemText>@_vm.Candidate.Email</MudListItemText>
                                </MudListItem>
                            </MudList>

                            <MudStack Row Spacing="1">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@OpenCandidateInlineDialog"
                                           StartIcon="@Icons.Material.Filled.PersonSearch">
                                    Ver mais
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                           Disabled="@string.IsNullOrWhiteSpace(_vm.Candidate.ResumeUrl)"
                                           StartIcon="@Icons.Material.Filled.Description"
                                           Href="@_vm.Candidate.ResumeUrl"
                                           Target="_blank">
                                    Ver currículo
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Coluna direita -->
            <MudItem xs="12" md="8">

                <!-- Vaga + Status -->
                <MudCard Class="elev mb-4">
                    <div class="card-header accent-primary">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.WorkOutline" />
                            <MudText Typo="Typo.subtitle1">Vaga e status</MudText>
                        </MudStack>
                    </div>

                    <MudCardContent Class="pa-4">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack>
                                <MudText Typo="Typo.subtitle1" Class="font-bold">@_vm.Vacancy.Title</MudText>
                                <MudText Typo="Typo.caption" Class="text-dim">
                                    Aberta em @(_vm.Vacancy.OpeningDate?.ToString("dd/MM/yyyy") ?? "-") •
                                    Candidatou-se em @_vm.AppliedAt.ToString("dd/MM/yyyy")
                                </MudText>
                            </MudStack>

                            <MudChip T="string" Color="@StatusColor(_vm.Status)" Variant="Variant.Filled" Style="font-weight:600">
                                @DisplayStatus(_vm.Status)
                            </MudChip>
                        </MudStack>

                        <MudDivider Class="my-3" />

                        <MudStack Row Spacing="1">
                            <MudButton Color="Color.Success" Disabled="@(_busy || _vm.Status == ApplicationStatus.Approved)"
                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                       OnClick="@(()=>UpdateStatusAsync(ApplicationStatus.Approved))">
                                Aprovar
                            </MudButton>
                            <MudButton Color="Color.Error" Variant="Variant.Outlined"
                                       Disabled="@(_busy || _vm.Status == ApplicationStatus.Rejected)"
                                       StartIcon="@Icons.Material.Filled.Cancel"
                                       OnClick="@(()=>UpdateStatusAsync(ApplicationStatus.Rejected))">
                                Rejeitar
                            </MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                <!-- Agendar Entrevista -->
                <MudCard Class="elev">
                    <div class="card-header accent-info">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Event" />
                            <MudText Typo="Typo.subtitle1">Agendar entrevista</MudText>
                        </MudStack>
                    </div>

                    <MudCardContent Class="pa-4">
                        <MudForm @ref="_form" Disabled="_busy">
                            <MudGrid>
                                <MudItem xs="12" md="4">
                                    <MudDatePicker Label="Data*" @bind-Date="_interview.StartDate" Required="true" />
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudTimePicker Label="Hora*" @bind-Time="_interview.StartTime" Required="true" />
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudSelect T="int" Label="Duração (min)*" @bind-Value="_interview.DurationMinutes" Required="true">
                                        @foreach (var d in new[] {30,45,60,90})
                                        {
                                            <MudSelectItem Value="@(d)">@d</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Local (presencial)" @bind-Value="_interview.Location" />
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Link (Meet/Teams)" @bind-Value="_interview.MeetingLink" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudTextField Label="Observações" @bind-Value="_interview.Notes" Lines="3" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudButton Color="Color.Primary" OnClick="ScheduleInterviewAsync" Disabled="_busy"
                                               StartIcon="@Icons.Material.Filled.EventAvailable">
                                        Agendar
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudForm>

                        @if (_vm.Interviews.Any())
                        {
                            <MudDivider Class="my-3" />
                            <MudText Typo="Typo.subtitle2" Class="font-bold mb-2">Agenda de entrevistas</MudText>

                            <MudList Dense="true" Class="list-clean" T="string">
                                @foreach (var it in _vm.Interviews.OrderByDescending(i => i.StartAt))
                                {
                                    <MudListItem>
                                        <MudListItemIcon><MudIcon Icon="@Icons.Material.Filled.Event" /></MudListItemIcon>
                                        <MudListItemText>
                                            <div class="font-medium">
                                                @it.StartAt.LocalDateTime.ToString("dd/MM/yyyy HH:mm")
                                                — @($"{it.DurationMinutes} min")
                                            </div>
                                            <small class="text-dim">
                                                @if (!string.IsNullOrWhiteSpace(it.Location))
                                                { <span>Presencial: @it.Location</span> }
                                                @if (!string.IsNullOrWhiteSpace(it.Location) && !string.IsNullOrWhiteSpace(it.MeetingLink))
                                                { <span> • </span> }
                                                @if (!string.IsNullOrWhiteSpace(it.MeetingLink))
                                                { <span>Link: @it.MeetingLink</span> }
                                            </small>
                                        </MudListItemText>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudCardContent>
                </MudCard>

            </MudItem>
        </MudGrid>
    }
</MudContainer>

@if (_showDetails)
{
    <!-- Overlay de detalhes do candidato -->
    <MudOverlay Visible="true" OnClick="@CloseCandidateInlineDialog" DarkBackground="true"
                Class="d-flex align-center justify-center">
        <MudPaper Class="pa-4" Style="width: 720px; max-width: 95vw;" Elevation="8" @onclick:stopPropagation="true">
            <MudStack Spacing="2">
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                         <MudAvatar Size="Size.Large" Image="@_vm.Candidate.ProfilePictureUrl" Color="Color.Primary"> @if (string.IsNullOrEmpty(@_vm.Candidate.ProfilePictureUrl)) {
                                @(_vm.Candidate.Initials)
                                    } else
                                    {

                                <MudImage Src="@_vm.Candidate.ProfilePictureUrl"></MudImage>
                            }
                        </MudAvatar>
                        <MudText Typo="Typo.h6">@_vm.Candidate.FullName</MudText>
                    </MudStack>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="@CloseCandidateInlineDialog" />
                </MudStack>

                <MudDivider Class="my-2" />

                <MudSimpleTable Dense="true">
                    <thead><tr><th>Campo</th><th>Valor</th></tr></thead>
                    <tbody>
                        <tr><td>Curso</td><td>@_vm.Candidate.Course</td></tr>
                        <tr><td>Período</td><td>@_vm.Candidate.Semester</td></tr>
                        <tr><td>Cidade/UF</td><td>@_vm.Candidate.City - @_vm.Candidate.UF</td></tr>
                        <tr><td>E-mail</td><td>@_vm.Candidate.Email</td></tr>
                    </tbody>
                </MudSimpleTable>

                <MudStack Row Spacing="2" Class="mt-2">
                    <MudButton Variant="Variant.Outlined"
                               Disabled="@string.IsNullOrWhiteSpace(_vm.Candidate.ResumeUrl)"
                               StartIcon="@Icons.Material.Filled.Description"
                               Href="@_vm.Candidate.ResumeUrl"
                               Target="_blank">
                        Ver currículo
                    </MudButton>
                    <MudSpacer />
                    <MudButton Color="Color.Primary" OnClick="@CloseCandidateInlineDialog">Fechar</MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudOverlay>
}


<style>
    /* barra de acento dos headers */
    .card-header.accent-primary::before {
        background: var(--mud-palette-primary);
    }

    .card-header.accent-info::before {
        background: var(--mud-palette-info);
    }

    /* tipografia utilitária */
    .font-bold {
        font-weight: 700;
    }

    .font-medium {
        font-weight: 600;
    }

    .text-dim {
        color: var(--mud-palette-text-secondary);
    }
</style>



@code {
    [Parameter] public Guid applicationId { get; set; }
    [Parameter] public Guid candidateId { get; set; }

    private MudForm? _form;
    private bool _busy;
    private bool _loaded;
    private bool _hydrated;
    private bool _notFound;

    private const string ApiPublicBase = "https://localhost:7095"; // ajuste p/ seu ambiente

    private static string? ToAbsolute(string? path)
    {
        if (string.IsNullOrWhiteSpace(path)) return null;
        if (path.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return path;
        var p = path.StartsWith("/") ? path : "/" + path;
        return $"{ApiPublicBase.TrimEnd('/')}{p}";
    }

    // --------- VM (apenas para UI; ligue com seu serviço depois) ----------
    private ApplicationManageVm _vm = new();
    private InterviewForm _interview = new();

    protected override Task OnInitializedAsync() => Task.CompletedTask;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hydrated && firstRender)
        {
            _hydrated = true;
            await CurrentUser.RefreshAsync();
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            // TODO: amarrar com EnterpriseService.GetManageApplicationAsync(id)
            // abaixo: placeholders para demonstrar o layout

            var applicationDto = await EnterpriseService.GetApplicationByApplicationId(applicationId);
            var candidateProfileDto = await EnterpriseService.GetCandidateProfileInfoByCandidateId(candidateId);
            var interviews = await EnterpriseService.GetInterviewsByApplicationIdAsync(applicationDto.ApplicationIdentifier);

            _vm = new ApplicationManageVm
            {
                ApplicationIdentifier = applicationDto.ApplicationIdentifier,
                Status = applicationDto.StatusEnum,
                AppliedAt = applicationDto.DataCandidatura,
                Vacancy = new VacancyVm { Title = applicationDto.TituloVaga, OpeningDate = applicationDto.DataCadastroVaga },
                Candidate = new CandidateVm
                {
                    FullName = candidateProfileDto.FullName,
                    Course = candidateProfileDto.CourseName,
                    Semester = "5",
                    City = candidateProfileDto.Address.City,
                    UF = candidateProfileDto.Address.Uf,
                    Email = candidateProfileDto.Email,
                    ProfilePictureUrl = ToAbsolute(candidateProfileDto.ProfilePicturePath), // se houver
                    ResumeUrl = ToAbsolute(candidateProfileDto.ResumePath), // se houver
                    HasResume = true
                },

                Interviews = (interviews ?? new List<ResponseGetInterviewItemJson>())
                .OrderByDescending(i => i.StartAt)
                .Select(i => new InterviewVm
                {
                    InterviewIdentifier = i.InterviewIdentifier,
                    StartAt = i.StartAt,              // renderize com .LocalDateTime na UI
                    DurationMinutes = i.DurationMinutes,
                    Location = i.Location,
                    MeetingLink = i.MeetingLink,
                    Notes = i.Notes
                })
                .ToList()
            };

            _loaded = true;
        }
        catch
        {
            _notFound = true;
            _loaded = true;
        }
    }

    private async Task UpdateStatusAsync(ApplicationStatus newStatus)
    {
        if (_busy || _vm.Status == newStatus) return;

        _busy = true;
        try
        {
            var (ok, err) = await EnterpriseService.UpdateApplicationStatus(
                _vm.ApplicationIdentifier, newStatus);

            if (!ok)
            {
                Snackbar.Add(err ?? "Não foi possível atualizar o status.", Severity.Error);
                return;
            }

            _vm.Status = newStatus;
            Snackbar.Add($"Status atualizado para {DisplayStatus(newStatus)}.", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Erro ao comunicar com a API.", Severity.Error);
        }
        finally
        {
            _busy = false;
        }
    }


    private async Task ScheduleInterviewAsync()
    {
        await _form!.Validate();
        if (!_form.IsValid)
        {
            Snackbar.Add("Preencha data, hora e duração.", Severity.Warning);
            return;
        }

        if (_interview.StartDate is null || _interview.StartTime is null)
        {
            Snackbar.Add("Informe data e hora válidas.", Severity.Warning);
            return;
        }

        // Pelo menos um dos campos de local precisa existir
        if (string.IsNullOrWhiteSpace(_interview.Location) && string.IsNullOrWhiteSpace(_interview.MeetingLink))
        {
            Snackbar.Add("Informe um local presencial ou um link de reunião.", Severity.Info);
            return;
        }

        _busy = true;
        try
        {
            var local = _interview.StartDate.Value.Add(_interview.StartTime.Value);
            var dtoStartUtc = new DateTimeOffset(local, TimeZoneInfo.Local.GetUtcOffset(local)).ToUniversalTime();

            var req = new RequestCreateScheduleInterviewJson
            {
                StartAt = dtoStartUtc,               // <-- UTC (offset 0)
                DurationMinutes = _interview.DurationMinutes,
                Location = _interview.Location,
                MeetingLink = _interview.MeetingLink,
                Notes = _interview.Notes
            };

            var (ok, err) = await EnterpriseService.ScheduleInterviewAsync(_vm.ApplicationIdentifier, req);
            if (!ok) { Snackbar.Add(err ?? "Não foi possível agendar a entrevista.", Severity.Error); return; }

            _vm.Interviews.Add(new InterviewVm
            {
                InterviewIdentifier = Guid.NewGuid(), // <- substitui o iid
                StartAt = dtoStartUtc,
                DurationMinutes = _interview.DurationMinutes,
                Location = _interview.Location,
                MeetingLink = _interview.MeetingLink,
                Notes = _interview.Notes
            });

            Snackbar.Add("Entrevista agendada!", Severity.Success);
            _interview = new InterviewForm();
            StateHasChanged();

        }
        catch
        {
            Snackbar.Add("Não foi possível agendar a entrevista.", Severity.Error);
        }
        finally { _busy = false; }
    }

    private void OpenResume()
    {
        Snackbar.Add("Abrindo currículo…", Severity.Normal);
    }

    private bool _showDetails;
    private void OpenCandidateInlineDialog() => _showDetails = true;
    private void CloseCandidateInlineDialog() => _showDetails = false;

    // -------- helpers de UI --------
    private static string DisplayStatus(ApplicationStatus s) => s switch
    {
        ApplicationStatus.Pending => "Pendente",
        ApplicationStatus.Approved => "Aprovado",
        ApplicationStatus.Rejected => "Rejeitado",
        _ => s.ToString()
    };

    private static Color StatusColor(ApplicationStatus s) => s switch
    {
        ApplicationStatus.Pending => Color.Warning,
        ApplicationStatus.Approved => Color.Success,
        ApplicationStatus.Rejected => Color.Error,
        _ => Color.Default
    };

    // -------- View Models (UI) --------
    private sealed class ApplicationManageVm
    {
        public Guid ApplicationIdentifier { get; set; }
        public ApplicationStatus Status { get; set; }
        public DateTime AppliedAt { get; set; }
        public VacancyVm Vacancy { get; set; } = new();
        public CandidateVm Candidate { get; set; } = new();
        public List<InterviewVm> Interviews { get; set; } = new();
    }

    private sealed class VacancyVm
    {
        public string Title { get; set; } = string.Empty;
        public DateTime? OpeningDate { get; set; }
    }

    private sealed class CandidateVm
    {
        public string FullName { get; set; } = string.Empty;
        public string? Course { get; set; }
        public string? Semester { get; set; }
        public string? City { get; set; }
        public string? UF { get; set; }
        public string? Email { get; set; }
        public string? ProfilePictureUrl { get; set; }
        public string? ResumeUrl { get; set; }
        public bool HasResume { get; set; }

        public string Initials =>
            string.Join("", (FullName ?? "").Split(' ', StringSplitOptions.RemoveEmptyEntries)
                .Take(2).Select(n => n[0])).ToUpperInvariant();
    }

    private sealed class InterviewVm
    {
        public Guid InterviewIdentifier { get; set; }
        public DateTimeOffset StartAt { get; set; }
        public int DurationMinutes { get; set; }
        public string? Location { get; set; }
        public string? MeetingLink { get; set; }
        public string? Notes { get; set; }
    }

    private sealed class InterviewForm
    {
        [Required] public DateTime? StartDate { get; set; }
        [Required] public TimeSpan? StartTime { get; set; }
        [Range(15, 300)] public int DurationMinutes { get; set; } = 30;
        public string? Location { get; set; }
        public string? MeetingLink { get; set; }
        public string? Notes { get; set; }
    }
}
