@page "/empresa/vagas/nova"
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Headers
@using PlataformaEstagio.Web.Components.Services.Enterprise
@using PlataformaEstagios.Communication.Requests
@using PlataformaEstagios.Domain.Enums
@inject IEnterpriseService EnterpriseService
@inject IUserContext CurrentUser
@inject ISnackbar Snackbar
@inject NavigationManager Nav

@* <AuthorizeView Roles="Enterprise"> *@
<MudContainer MaxWidth="MaxWidth.Medium" Class="px-6 py-4">

    <!-- HERO -->
    <MudPaper Class="hero-card elev mb-4">
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="hero-inner">
            <MudStack Spacing="1">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.WorkOutline" />
                    <MudText Typo="Typo.h5" Class="font-bold">Criar nova vaga</MudText>
                </MudStack>
                <MudText Typo="Typo.subtitle2" Class="text-dim">
                    Defina título, descrição, localização e requisitos. Você poderá editar depois.
                </MudText>
            </MudStack>

            <MudStack Row Spacing="1">
                <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => Nav.NavigateTo("/empresa/home"))">
                    Cancelar
                </MudButton>
                <MudButton Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Disabled="@_busy" OnClick="HandleSubmit">
                    Salvar
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>

    <MudPaper Class="elev">

        <div class="card-header accent-primary">
            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.Description" />
                <MudText Typo="Typo.subtitle1">Dados da vaga</MudText>
            </MudStack>
        </div>

        @if (!_loaded)
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-6">
                <MudProgressCircular Indeterminate="true" />
                <MudText Class="text-dim">Carregando dados da empresa...</MudText>
            </MudStack>
        }
        else
        {
            <MudCardContent Class="pa-4">

                <MudForm @ref="_form" Model="_model" OnValidSubmit="HandleSubmit">

                    <!-- Seção: Básico -->
                    <MudGrid Class="section">
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Title"
                                          Label="Título*"
                                          Required="true"
                                          For="@(() => _model.Title)"
                                          Placeholder="Ex.: Estagiário(a) de Sistemas de Informação" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Description"
                                          Label="Descrição"
                                          Lines="6"
                                          Placeholder="Fale sobre as responsabilidades, rotina e benefícios." />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-2" />

                    <!-- Seção: Local e área -->
                    <MudGrid Class="section">
                        <MudItem xs="12" md="7">
                            <MudTextField @bind-Value="_model.Location"
                                          Label="Localização*"
                                          Required="true"
                                          Placeholder="Ex.: Remoto - Brasil / São Paulo - SP (Remoto)" />
                        </MudItem>

                        <MudItem xs="12" md="5">
                            <MudSelect T="JobFunction"
                                       @bind-Value="_model.JobFunction"
                                       Label="Área de atuação*"
                                       Required="true">
                                @foreach (var a in Enum.GetValues<JobFunction>())
                                {
                                    <MudSelectItem Value="a">@a</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-2" />

                    <!-- Seção: Habilidades -->
                    <MudGrid Class="section">
                        <MudItem xs="12">
                            <MudText Typo="Typo.caption" Class="text-dim">Habilidades desejadas</MudText>
                            <MudTextField @bind-Value="_skillInput"
                                          Label="Adicionar habilidade"
                                          Placeholder="Ex.: C#, Git, SQL"
                                          OnKeyUp="OnSkillKeyUp" />
                            <MudChipSet T="string" Class="mb-1">
                                @foreach (var s in _model.RequiredSkills)
                                {
                                    <MudChip T="string"
                                             Color="Color.Default"
                                             Variant="Variant.Outlined"
                                             Size="Size.Small"
                                             Closeable="true"
                                             OnClose="@( (MudChip<string> _) => RemoveSkill(s) )">@s</MudChip>
                                }
                            </MudChipSet>
                            <MudText Typo="Typo.caption" Class="text-dim">
                                Pressione <strong>Enter</strong> para adicionar.
                            </MudText>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-2" />

                    <!-- Seção: Publicação -->
                    <MudGrid Class="section">
                        <MudItem xs="12" md="6">
                            <MudDatePicker Label="Expira em"
                                           @bind-Date="_expiresDate"
                                           Editable="true"
                                           Clearable="true"
                                           DisplayMonths="1"
                                           DisableToolbar="false"
                                           PickerMonth="@DateTime.Today"
                                           MinDate="@DateTime.Today"
                                           T="DateTime?" />
                        </MudItem>

                        <MudItem xs="12" md="6" Class="flex-center-y">
                            <MudSwitch T="bool" @bind-Checked="_model.IsActive" Color="Color.Success">Ativa</MudSwitch>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-2" />

                    <!-- Ações -->
                    <MudStack Row Spacing="1" Class="actions">
                        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => Nav.NavigateTo("/empresa/home"))">
                            Cancelar
                        </MudButton>
                        <MudButton Type="Submit"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="@_busy"
                                   OnClick="HandleSubmit">
                            Salvar
                        </MudButton>
                    </MudStack>

                </MudForm>
            </MudCardContent>
        }
    </MudPaper>
</MudContainer>

<style>
    /* mantém consistência com seu global */
    .section {
        margin-bottom: .25rem;
    }

    /* centraliza verticalmente o switch no grid */
    .flex-center-y {
        display: flex;
        align-items: center;
    }

    /* barra do header com cor primária */
    .card-header.accent-primary::before {
        background: var(--mud-palette-primary);
    }
</style>

@* </AuthorizeView> *@

@code {
    private MudForm? _form;
    private bool _busy;
    private bool _loaded;
    private bool _hydrated;

    // input temporário para adicionar chips
    private string _skillInput = string.Empty;

    // DatePicker trabalha melhor com DateTime? local; converto para UTC no submit
    private DateTime? _expiresDate;

    // DTO do backend (agora com novos campos)
    private RequestCreateVacancyJson _model = new()
    {
        IsActive = true,
        Location = "Remoto - Brasil",
        RequiredSkills = new List<string>(),
        JobFunction = JobFunction.TI
    };

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hydrated && firstRender)
        {
            _hydrated = true;
            await CurrentUser.RefreshAsync();
            _loaded = true;
            StateHasChanged();
        }
    }

    private void OnSkillKeyUp(KeyboardEventArgs e)
    {
        if (e.Key is "Enter")
        {
            AddSkillFromInput();
        }
    }

    private void AddSkillFromInput()
      {
        var txt = (_skillInput ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(txt)) return;

        // evita duplicados (case-insensitive)
        
        _model.RequiredSkills.Add(txt);

        _skillInput = "";
        StateHasChanged();
    }

    private void RemoveSkill(string s)
    {
        _model.RequiredSkills.Remove(s);
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        await _form!.Validate();
        if (!_form.IsValid) return;

        if (!CurrentUser.IsAuthenticated)
        {
            Snackbar.Add("Usuário não autenticado. Recarregue a página ou faça login novamente.", Severity.Error);
            return;
        }

        try
        {
            _busy = true;

            _model.ExpiresAtUtc = _expiresDate.HasValue
                ? DateTime.SpecifyKind(_expiresDate.Value, DateTimeKind.Local).ToUniversalTime()
                : null;

            var enterpriseId = CurrentUser.UserTypeId;
            if (enterpriseId is null)
            {
                Snackbar.Add("Empresa não identificada nas claims.", Severity.Warning);
                return;
            }

            var result = await EnterpriseService.CreateAsync(enterpriseId.Value, _model);
            if (result.Success)
            {
                Snackbar.Add("Vaga criada com sucesso!", Severity.Success);
                Nav.NavigateTo("/empresa/home");
            }
            else
            {
                Snackbar.Add($"Falha ao criar vaga: {result.Error}", Severity.Error);
            }
        }
        finally
        {
            _busy = false;
        }
    }
}
