@page "/candidato/home"
@using System.Security.Claims
@using PlataformaEstagio.Web.Components.Services.Candidate
@using PlataformaEstagios.Communication.Responses
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject IUserContext CurrentUser

<AuthorizeView Context="auth" Roles="Candidate">
    <MudContainer MaxWidth="MaxWidth.False" Class="px-6 py-4">

        <!-- HERO / HEADER -->
        <MudPaper Class="hero-card mb-4" Elevation="0">
            <MudGrid Class="hero-inner" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudItem xs="12" md="8">
                    <MudStack Spacing="1">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Outlined.Bolt" Size="Size.Medium" />
                            <MudText Typo="Typo.h5" Class="font-bold">
                                Olá, @GetDisplayName(auth.User) 👋
                            </MudText>
                        </MudStack>

                        <MudText Typo="Typo.body2" Class="text-dim">
                            @(ProfileCompletion >= 100
                                    ? "Perfil completo! Você já pode focar nas vagas."
                                    : "Finalize seu perfil para receber recomendações mais precisas.")
                        </MudText>


                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="mt-1">
                            @if (ProfileCompletion < 100)
                            {
                                <MudProgressLinear Value="@ProfileCompletion" Color="Color.Success" Class="hero-progress" />
                                <MudText Typo="Typo.caption" Class="text-dim">@ProfileCompletion%</MudText>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Success"
                                         StartIcon="@Icons.Material.Filled.CheckCircle"
                                         Variant="Variant.Filled">
                                    Perfil completo
                                </MudChip>
                            }
                        </MudStack>
                    </MudStack>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudStack Row Justify="Justify.FlexEnd" Spacing="1" Class="hero-actions">
                        @if (ProfileCompletion < 100)
                        {
                            <MudButton Variant="Variant.Filled"
                                       StartIcon="@Icons.Material.Filled.Person"
                                       Color="Color.Primary"
                                       OnClick="OnIrParaPerfil">
                                Completar Perfil
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Outlined"
                                       StartIcon="@Icons.Material.Filled.Edit"
                                       OnClick="OnIrParaPerfil">
                                Editar
                            </MudButton>
                        }

                        <MudButton Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.Search"
                                   OnClick="OnBuscarvagas">
                            Buscar Vagas
                        </MudButton>

                        <MudButton Variant="Variant.Text"
                                   StartIcon="@Icons.Material.Filled.NotificationsActive"
                                   OnClick="OnConfigurarAlertas">
                            Alertas
                        </MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- GRID -->
        <MudGrid GutterSize="GutterSize.Medium">
            <!-- ESQUERDA -->
            <MudItem xs="12" md="8">
                <!-- Vagas recentes -->
                <MudCard Class="elev mb-4">
                    <MudCardHeader Class="card-header">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Outlined.WorkOutline" />
                            <MudText Typo="Typo.h6">Vagas recentes</MudText>
                        </MudStack>
                    </MudCardHeader>

                    @if (_isLoading)
                    {
                        <MudCardContent>
                            <MudSkeleton Height="28px" Class="mb-2" />
                            <MudSkeleton Height="28px" Class="mb-2" />
                            <MudSkeleton Height="28px" Class="mb-2" />
                        </MudCardContent>
                    }
                    else
                    {
                        <MudCardContent>
                            <MudTable Items="RecentVacancies"
                                      Hover="true"
                                      Dense="true"
                                      FixedHeader="true"
                                      Height="260px"
                                      Elevation="0"
                                      Class="table-compact">
                                <HeaderContent>
                                    <MudTh>Vaga</MudTh>
                                    <MudTh>Empresa</MudTh>
                                    <MudTh>Data de publicação</MudTh>
                                    <MudTh>Status</MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd>
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body2" Class="font-medium">@context.Titulo</MudText>
                                            <MudText Typo="Typo.caption" Class="text-dim">@context.DataAbertura.ToString("dd/MM/yyyy HH:mm")</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd>@context.EnterpriseName</MudTd>
                                    <MudTd>@context.DataAbertura.ToString("dd/MM/yyyy HH:mm")</MudTd>
                                    <MudTd>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                            @context.Status
                                        </MudChip>
                                    </MudTd>
                                    <MudTd Class="text-right">
                                        <MudButton Size="Size.Small"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Send"
                                                   OnClick="@(() => Apply(context))">
                                            Candidatar-se
                                        </MudButton>
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudAlert Severity="Severity.Info" Elevation="0">
                                        Nenhuma vaga disponível no momento.
                                    </MudAlert>
                                </NoRecordsContent>
                            </MudTable>
                        </MudCardContent>
                    }
                </MudCard>

                <!-- Minhas inscrições recentes -->
                <MudCard Class="elev">
                    <MudCardHeader Class="card-header">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Outlined.History" />
                            <MudText Typo="Typo.h6">Minhas inscrições recentes</MudText>
                        </MudStack>
                    </MudCardHeader>

                    @if (_isLoading)
                    {
                        <MudCardContent>
                            <MudSkeleton Height="28px" Class="mb-2" />
                            <MudSkeleton Height="28px" Class="mb-2" />
                        </MudCardContent>
                    }
                    else
                    {
                        <MudCardContent>
                            <MudTable Items="RecentApplications"
                                      Dense="true"
                                      Hover="true"
                                      Elevation="0"
                                      Class="table-compact">
                                <HeaderContent>
                                    <MudTh>Vaga</MudTh>
                                    <MudTh>Empresa</MudTh>
                                    <MudTh>Data</MudTh>
                                    <MudTh>Status</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd>@context.Vaga</MudTd>
                                    <MudTd>@context.Empresa</MudTd>
                                    <MudTd>@context.Data.ToString("dd/MM/yyyy")</MudTd>
                                    <MudTd>
                                        <MudChip T="string" Color="@StatusColor(context.Status)" Variant="Variant.Filled" Size="Size.Small">
                                            @context.Status
                                        </MudChip>
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudAlert Severity="Severity.Info" Elevation="0">
                                        Nenhuma candidatura até o momento.
                                    </MudAlert>
                                </NoRecordsContent>
                            </MudTable>
                        </MudCardContent>
                    }
                </MudCard>
            </MudItem>

            <!-- DIREITA -->
            <MudItem xs="12" md="4">
                <!-- Horas obrigatórias -->
                <MudCard Class="elev mb-4">
                    <MudCardHeader Class="card-header">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Outlined.Schedule" />
                            <MudText Typo="Typo.h6">Horas obrigatórias</MudText>
                        </MudStack>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="1">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">@CompletedHours/@RequiredHours h</MudText>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info">@Math.Round(HoursPercent)%</MudChip>
                            </MudStack>
                            <MudProgressLinear Value="@HoursPercent" Color="Color.Info" />
                            <MudButton Variant="Variant.Outlined"
                                       StartIcon="@Icons.Material.Filled.UploadFile"
                                       OnClick="@(()=>Snackbar.Add("Enviar relatório de horas (TODO)", Severity.Info))">
                                Enviar relatório
                            </MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                <!-- Próximas entrevistas -->
                <MudCard Class="elev mb-4">
                    <MudCardHeader Class="card-header">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Outlined.Event" />
                            <MudText Typo="Typo.h6">Próximas entrevistas</MudText>
                        </MudStack>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (UpcomingInterviews.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info" Elevation="0">Sem entrevistas marcadas.</MudAlert>
                        }
                        else
                        {
                            <MudList Dense="true" Class="list-clean" T="string">
                                @foreach (var i in UpcomingInterviews)
                                {
                                    <MudListItem>
                                        <MudListItemIcon>
                                            <MudIcon Icon="@Icons.Material.Filled.Event" />
                                        </MudListItemIcon>
                                        <MudListItemText>
                                            <div class="font-medium">@i.NomeEmpresa • @i.TituloVaga</div>
                                            <small class="text-dim">@i.DataEntrevista.ToString("dd/MM HH:mm") • @i.Canal</small>
                                        </MudListItemText>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudCardContent>
                </MudCard>

                <!-- Notificações -->
                <MudCard Class="elev">
                    <MudCardHeader Class="card-header">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Outlined.Notifications" />
                            <MudText Typo="Typo.h6">Notificações</MudText>
                        </MudStack>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (Notifications.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info" Elevation="0">Sem novas notificações.</MudAlert>
                        }
                        else
                        {
                            <MudTimeline Class="timeline-clean">
                                @foreach (var n in Notifications)
                                {
                                    <MudTimelineItem>
                                        <div class="font-medium">@n.Texto</div>
                                        <small class="text-dim">@n.Data.ToString("dd/MM HH:mm")</small>
                                    </MudTimelineItem>
                                }
                            </MudTimeline>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudContainer>
</AuthorizeView>

<style>
    /* ---- Hero ---- */
    .hero-card {
        border: 1px solid var(--mud-palette-divider);
        border-radius: 16px;
        background: radial-gradient(1200px 250px at 10% -40%, color-mix(in oklab, var(--mud-palette-primary) 12%, transparent) 0%, transparent 60%), var(--mud-palette-surface);
    }

    .hero-inner {
        padding: 18px 20px;
    }

    .hero-actions > * {
        white-space: nowrap;
    }

    .hero-progress {
        width: 200px;
        max-width: 50vw;
    }

    .text-dim {
        color: var(--mud-palette-text-secondary);
    }

    .font-bold {
        font-weight: 700;
    }

    .font-medium {
        font-weight: 600;
    }

    /* ---- Cards / Containers ---- */
    .elev {
        border: 1px solid var(--mud-palette-divider);
        border-radius: 12px;
        overflow: hidden; /* impede a barra do header de “vazar” */
    }

    /* Header com barra lateral + tint que respeita o tema */
    .card-header {
        position: relative;
        padding: 10px 14px 10px 20px; /* espaço extra p/ a barra */
        border-bottom: 1px solid var(--mud-palette-divider);
    }

        .card-header::before {
            content: "";
            position: absolute;
            inset: 0 auto 0 0;
            width: 6px;
            border-radius: 12px 0 0 0; /* acompanha o raio do card */
            background: linear-gradient(180deg, color-mix(in oklab, var(--mud-palette-primary) 92%, white 8%), color-mix(in oklab, var(--mud-palette-primary) 62%, white 38%));
        }
        /* Tipografia do título e cor do ícone */
        .card-header .mud-typography {
            font-weight: 700;
            color: var(--mud-palette-text-primary);
            letter-spacing: .2px;
        }

        .card-header .mud-icon-root {
            color: var(--mud-palette-primary);
            opacity: .95;
        }

    /* ---- Tabelas ---- */
    .table-compact .mud-table-container {
        border-radius: 10px;
    }

    .table-compact .mud-table * th {
        font-weight: 600;
    }

    .table-compact .mud-table-row:hover {
        background: color-mix(in oklab, var(--mud-palette-primary) 9%, transparent);
    }

    /* ---- Lists / Timeline ---- */
    .list-clean .mud-list-item:hover {
        background: color-mix(in oklab, var(--mud-palette-primary) 7%, transparent);
    }

    .timeline-clean .mud-timeline {
        --mud-palette-lines-default: var(--mud-palette-divider);
    }

    /* ---- Responsivo ---- */
    @@media (max-width: 899px) {
        .hero-progress

    {
        width: 100%;
    }

    .hero-inner {
        padding: 14px;
    }

    }
</style>



@code {
    @inject ICandidateService _service
    
    private bool _isLoading = true;
    private Guid? _enterpriseId;
    private List<RecentVacanciesVm> RecentVacancies { get; set; } = new();
    private List<RecentApplicationsVm> RecentApplications { get; set; } = new();
    private List<InterviewVm> UpcomingInterviews { get; set; } = new();

    private bool _hydrated;
    private bool _loadingJobs;

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hydrated && firstRender)
        {
            _hydrated = true;
            await CurrentUser.RefreshAsync();
            await LoadCandidateInfoAsync();
            StateHasChanged();
        }
    }

    private async Task LoadCandidateInfoAsync()
    {
        if (_loadingJobs) return;   // trava reentrada
        _loadingJobs = true;
        _isLoading = true;

        try
        {
            if (CurrentUser.UserTypeId is Guid id)
            {
                var profile = await _service.GetByIdAsync(id);

                ProfileCompletion = ComputeProfileCompletion(profile);



                var vagasRecentes = await _service.GetOpenVacanciesAsync();
                RecentVacancies = vagasRecentes.Select(v => new RecentVacanciesVm(
                    
                    v.VacancyIdentifier,
                    v.Title,
                    v.OpenedAt.ToLocalTime(),
                    v.Applicants,
                    v.Status,
                    v.EnterpriseName)).ToList();

                var inscricoesRecentes = await _service.GetRecentApplicationsAsync(id);
                RecentApplications = inscricoesRecentes.Select(a => new RecentApplicationsVm(
                    a.TituloVaga,
                    a.NomeEmpresa,
                    a.DataCandidatura.ToLocalTime(),
                    a.Status)).ToList();

                // 1) busca entrevistas (pode vir null do service)
                var interviews = await _service.GetAllInterviewsByCandidateIdAsync(id)
                                 ?? Array.Empty<ResponseGetInterviewItemJson>();

                // 2) índice das candidaturas (se a lista estiver vazia, vira dicionário vazio)

                // 3) monta os cards; se não achar candidatura correspondente, usa "—"
                UpcomingInterviews = interviews
                    .Where(i => i.StartAt > DateTimeOffset.UtcNow)
                    .OrderBy(i => i.StartAt)
                    .Take(5)
                    .Select(i =>
                    {
                        var NomeEmpresa = vagasRecentes.FirstOrDefault(vaga => vaga.EnterpriseIdentifier == i.EnterpriseIdentifier)?.EnterpriseName ?? "-";
                        var TituloVaga = inscricoesRecentes.FirstOrDefault(vaga => vaga.ApplicationIdentifier == i.ApplicationIdentifier)?.TituloVaga ?? "—";
                        var canal = ChannelLabel(i.Location, i.MeetingLink);

                        return new InterviewVm(
                            NomeEmpresa,
                            TituloVaga,
                            i.StartAt.LocalDateTime,   // <- melhor que .Date.ToLocalTime()
                            canal
                        );
                    })
                    .ToList();

            }
            else
            {
                Snackbar.Add("ID do candidato não encontrado nas claims.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Falha ao carregar vagas: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            _loadingJobs = false;
            // segura o render no fim do ciclo atual
            await InvokeAsync(StateHasChanged);
        }
    }
    private static string ChannelLabel(string? location, string? link)
    {
        if (!string.IsNullOrWhiteSpace(link))
        {
            var l = link.ToLowerInvariant();
            if (l.Contains("meet.google")) return "Google Meet";
            if (l.Contains("teams.microsoft")) return "Microsoft Teams";
            return "Online";
        }
        return string.IsNullOrWhiteSpace(location) ? "—" : location;
    }

    private void OnIrParaPerfil()
    {
        Nav.NavigateTo("/candidato/perfil/editar");
    }
    private void OnBuscarvagas()
    {
        Snackbar.Add("Ir para perfil (TODO)", Severity.Info);
    }
    private void OnConfigurarAlertas()
    {
        Snackbar.Add("Ir para perfil (TODO)", Severity.Info);
    }

    private void Apply(RecentVacanciesVm job)
    {
        Nav.NavigateTo($"/candidato/vagas/{job.JobId}/aplicar");
    }

    private Color StatusColor(string status) => status switch
    {
        "Approved" => Color.Success,
        "Pending" => Color.Warning,
        "Rejected" => Color.Error,
        _ => Color.Warning
    };

    // --- VMs simples (poderiam virar DTOs no projeto)
    private record RecentVacanciesVm(Guid JobId, string Titulo, DateTime DataAbertura, int Inscritos, string Status, string EnterpriseName);
    private record RecentApplicationsVm(string Vaga, string Empresa, DateTime Data, string Status);
    private record AppointmentVm(string Titulo, DateTime Data, string Local);
    private record NotificationVm(string Texto, DateTime Data);
    private record InterviewVm(string NomeEmpresa, string TituloVaga, DateTime DataEntrevista, string Canal);

    private static string GetDisplayName(ClaimsPrincipal user)
        => user.FindFirst("nickname")?.Value
           ?? user.Identity?.Name
           ?? user.FindFirst(ClaimTypes.Email)?.Value
           ?? "Usuário";

    // --- usuário (via Claims). Garanta que o login preenche o ClaimTypes.Name ou "name".
    private string FirstName = "candidato";
    private int ProfileCompletion = 60;

    // --- horas obrigatórias
    private int RequiredHours = 160;
    private int CompletedHours = 48;
    private double HoursPercent => RequiredHours == 0 ? 0 : (CompletedHours * 100.0 / RequiredHours);

    private List<AppointmentVm> Appointments = new()
    {
        new("Entrevista • Tech Corp", DateTime.Today.AddDays(1).AddHours(14), "Google Meet")
    };

    private List<NotificationVm> Notifications = new()
    {
        new("Sua inscrição na Tech Corp mudou para 'Em análise'", DateTime.Today.AddHours(-5)),
        new("Nova vaga de Blazor publicada pela DevHouse", DateTime.Today.AddDays(-1))
    };

    // Helpers
    private static string OnlyDigits(string? s) =>
        string.IsNullOrWhiteSpace(s) ? string.Empty : new string(s.Where(char.IsDigit).ToArray());

    private static bool TwoLetters(string? s) =>
        !string.IsNullOrWhiteSpace(s) && s.Trim().Length == 2;

    // Regra simples: 10 itens, cada um vale 10%
    private static int ComputeProfileCompletion(PlataformaEstagios.Communication.Responses.ResponseGetCandidateProfileJson dto)
    {
        int total = 10, score = 0;

        if (!string.IsNullOrWhiteSpace(dto.FullName)) score++;
        if (dto.BirthDate.HasValue) score++;
        if (!string.IsNullOrWhiteSpace(dto.CourseName)) score++;
        if (!string.IsNullOrWhiteSpace(dto.BioResume)) score++;

        var a = dto.Address;
        if (!string.IsNullOrWhiteSpace(a?.Street)) score++;
        if (!string.IsNullOrWhiteSpace(a?.City)) score++;
        if (TwoLetters(a?.Uf)) score++;
        if (OnlyDigits(a?.Cep).Length == 8) score++;

        if (!string.IsNullOrWhiteSpace(dto.ProfilePicturePath)) score++;
        if (!string.IsNullOrWhiteSpace(dto.ResumePath)) score++;

        return (int)Math.Round(score * 100.0 / total);
    }

}
