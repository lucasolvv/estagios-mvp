@page "/candidato/home"
@using System.Security.Claims
@using PlataformaEstagio.Web.Components.Services.Candidate
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject IUserContext CurrentUser

<AuthorizeView Context="auth" Roles="Candidate">
    <MudContainer MaxWidth="MaxWidth.False" Class="px-6 py-4">
    <MudGrid>
        <!-- Header / Perfil -->
        <MudItem xs="12">
                <MudPaper Class="pa-6">
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="2">
                    <MudStack>
                        <MudText Typo="Typo.h5" Class="font-weight-bold">
                                Olá, @GetDisplayName(auth.User) 👋
                        </MudText>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                            Continue seu perfil para receber recomendações mais precisas.
                        </MudText>
                    </MudStack>

                    <MudStack Row Spacing="1">
                            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Person" Color="Color.Primary" OnClick="OnIrParaPerfil">
                            Completar Perfil (@ProfileCompletion% )
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Search" OnClick="OnBuscarvagas">
                            Buscar Vagas
                        </MudButton>
                        <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Alarm" OnClick="OnConfigurarAlertas">
                            Alertas
                        </MudButton>
                    </MudStack>
                </MudStack>

                <MudProgressLinear Class="mt-3" Value="@ProfileCompletion" Color="Color.Success" />
            </MudPaper>
        </MudItem>

        <!-- Coluna esquerda -->
        <MudItem xs="12" md="8">
            <!-- Vagas recomendadas -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Vagas recentes</MudText>
                </MudCardHeader>
                    @if (_isLoading)
                    {
                        <MudProgressLinear Indeterminate="true" Class="mb-2" />
                        <MudText Color="Color.Secondary">Carregando vagas...</MudText>
                    }
                    else
                    {
                        <MudCardContent>
                            <MudTable Items="ActiveJobs" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Vaga</MudTh>
                                    <MudTh>Empresa</MudTh>
                                    <MudTh>Data de publicação</MudTh>
                                    <MudTh>Status</MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd>@context.Titulo</MudTd>
                                    <MudTd>@context.EnterpriseName</MudTd>
                                    <MudTd>@context.DataAbertura</MudTd>
                                    <MudTd>@context.Status</MudTd>
                                    <MudTd Class="text-right">
                                        <MudButton Size="Size.Small" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Send" OnClick="@(() => Apply(context))">
                                            Candidatar-se
                                        </MudButton>
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudText Nenhum registro encontrado.></MudText>
                                </NoRecordsContent>
                            </MudTable>
                        </MudCardContent>
                    }
                   
            </MudCard>

            <!-- Minhas inscrições recentes -->
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Minhas inscrições recentes</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="RecentApplications" Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Vaga</MudTh>
                            <MudTh>Empresa</MudTh>
                            <MudTh>Data</MudTh>
                            <MudTh>Status</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Vaga</MudTd>
                            <MudTd>@context.Empresa</MudTd>
                            <MudTd>@context.Data.ToString("dd/MM/yyyy")</MudTd>
                            <MudTd>
                                <MudChip T="string" Color="@StatusColor(context.Status)" Variant="Variant.Filled" Size="Size.Small">
                                    @context.Status
                                </MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Coluna direita -->
        <MudItem xs="12" md="4">
            <!-- Horas obrigatórias -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Horas obrigatórias</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack>
                        <MudText>@CompletedHours/@RequiredHours h</MudText>
                        <MudProgressLinear Value="@HoursPercent" Color="Color.Info" />
                        <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.UploadFile"
                                   OnClick="@(()=>Snackbar.Add("Enviar relatório de horas (TODO)", Severity.Info))">
                            Enviar relatório
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <!-- Próximos compromissos -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Próximos compromissos</MudText>
                </MudCardHeader>
                <MudCardContent>
                    @if (Appointments.Count == 0)
                    {
                        <MudText Color="Color.Secondary">Sem compromissos.</MudText>
                    }
                    else
                    {
                            <MudList Dense="true" T="AppointmentVm">
                            @foreach (var a in Appointments)
                            {
                                <MudListItem>
                                    <MudListItemIcon><MudIcon Icon="@Icons.Material.Filled.Event" /></MudListItemIcon>
                                    <MudListItemText>
                                        <div class="font-semibold">@a.Titulo</div>
                                        <small>@a.Data.ToString("dd/MM HH:mm") • @a.Local</small>
                                    </MudListItemText>
                                </MudListItem>
                            }
                        </MudList>
                    }
                </MudCardContent>
            </MudCard>

            <!-- Notificações -->
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Notificações</MudText>
                </MudCardHeader>
                <MudCardContent>
                    @if (Notifications.Count == 0)
                    {
                        <MudText Color="Color.Secondary">Sem novas notificações.</MudText>
                    }
                    else
                    {
                        <MudTimeline>
                            @foreach (var n in Notifications)
                            {
                                <MudTimelineItem>
                                    <div class="font-medium">@n.Texto</div>
                                    <small>@n.Data.ToString("dd/MM HH:mm")</small>
                                </MudTimelineItem>
                            }
                        </MudTimeline>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>


</AuthorizeView>


@code {
    @inject ICandidateService _service
    
    private bool _isLoading = true;
    private Guid? _enterpriseId;
    private List<RecentJobsVm> ActiveJobs { get; set; } = new();

    private bool _hydrated;
    private bool _loadingJobs;

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hydrated && firstRender)
        {
            _hydrated = true;
            await CurrentUser.RefreshAsync();
            await LoadCandidateInfoAsync();
            StateHasChanged();
        }
    }

    private async Task LoadCandidateInfoAsync()
    {
        if (_loadingJobs) return;   // trava reentrada
        _loadingJobs = true;
        _isLoading = true;

        try
        {
            if (CurrentUser.UserTypeId is Guid id)
            {
                var vagasRecentes = await _service.GetOpenVacanciesAsync();
                ActiveJobs = vagasRecentes.Select(v => new RecentJobsVm(
                    
                    v.VacancyIdentifier,
                    v.Title,
                    v.OpenedAt.ToLocalTime(),
                    v.Applicants,
                    v.Status,
                    v.EnterpriseName)).ToList();
            }
            else
            {
                Snackbar.Add("ID do candidato não encontrado nas claims.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Falha ao carregar vagas: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            _loadingJobs = false;
            // segura o render no fim do ciclo atual
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnIrParaPerfil()
    {
        Snackbar.Add("Ir para perfil (TODO)", Severity.Info);
    }
    private void OnBuscarvagas()
    {
        Snackbar.Add("Ir para perfil (TODO)", Severity.Info);
    }
    private void OnConfigurarAlertas()
    {
        Snackbar.Add("Ir para perfil (TODO)", Severity.Info);
    }

    private void Apply(RecentJobsVm job)
    {
        Nav.NavigateTo($"/candidato/vagas/{job.JobId}/aplicar");
    }

    private Color StatusColor(string status) => status switch
    {
        "Aprovado" => Color.Success,
        "Entrevista marcada" => Color.Info,
        "Reprovado" => Color.Error,
        _ => Color.Warning
    };

    // --- VMs simples (poderiam virar DTOs no projeto)
    private record RecentJobsVm(Guid JobId, string Titulo, DateTime DataAbertura, int Inscritos, string Status, string EnterpriseName);
    private record ApplicationVm(string Vaga, string Empresa, DateTime Data, string Status);
    private record AppointmentVm(string Titulo, DateTime Data, string Local);
    private record NotificationVm(string Texto, DateTime Data);

    private static string GetDisplayName(ClaimsPrincipal user)
        => user.FindFirst("nickname")?.Value
           ?? user.Identity?.Name
           ?? user.FindFirst(ClaimTypes.Email)?.Value
           ?? "Usuário";

    // --- usuário (via Claims). Garanta que o login preenche o ClaimTypes.Name ou "name".
    private string FirstName = "candidato";
    private int ProfileCompletion = 60;

    // --- horas obrigatórias
    private int RequiredHours = 160;
    private int CompletedHours = 48;
    private double HoursPercent => RequiredHours == 0 ? 0 : (CompletedHours * 100.0 / RequiredHours);

    //--- dados mockados (substituir por serviços/repo)
    // private List<JobVm> RecommendedJobs = new()
    // {
    //     new("Estágio Frontend (Blazor)", "Tech Corp", "20h/sem", 1200m),
    //     new("Estágio QA", "Quality Labs", "30h/sem", 1500m),
    //     new("Estágio Suporte TI", "HelpDesk BR", "30h/sem", null),
    // };

    private List<ApplicationVm> RecentApplications = new()
    {
        new("Estágio Frontend (Blazor)", "Tech Corp", DateTime.Today.AddDays(-2), "Aguardando triagem"),
        new("Estágio QA", "Quality Labs", DateTime.Today.AddDays(-5), "Entrevista marcada")
    };

    private List<AppointmentVm> Appointments = new()
    {
        new("Entrevista • Tech Corp", DateTime.Today.AddDays(1).AddHours(14), "Google Meet")
    };

    private List<NotificationVm> Notifications = new()
    {
        new("Sua inscrição na Tech Corp mudou para 'Em análise'", DateTime.Today.AddHours(-5)),
        new("Nova vaga de Blazor publicada pela DevHouse", DateTime.Today.AddDays(-1))
    };
}
