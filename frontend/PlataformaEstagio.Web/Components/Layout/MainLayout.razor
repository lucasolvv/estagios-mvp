@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthStateProvider
@using PlataformaEstagio.Web.Components.Services.Auth
@inject PlataformaEstagio.Web.Components.Services.Auth.IAuthService Auth
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager Nav

<MudThemeProvider Theme="@_theme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<!-- App Shell: flex column para "footer sticky" sem sobreposição -->
<MudLayout Class="app-shell">
    <!-- APP BAR (mais clean, na Surface, com borda sutil) -->
    <MudAppBar Elevation="0" Dense="true" Class="appbar">
        <MudContainer MaxWidth="MaxWidth.Large" Class="appbar__inner">
            <MudText Typo="Typo.h6" Class="brand">
                StartCarreira
            </MudText>

            <MudSpacer />

            <AuthorizeView>
                <NotAuthorized>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.TwoTone.Login"
                               OnClick="@(() => Nav.NavigateTo("/"))">
                        Entrar
                    </MudButton>
                </NotAuthorized>

                <Authorized Context="auth">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                        <MudIconButton Icon="@(DarkLightModeButtonIcon)"
                                       Color="Color.Default"
                                       Size="Size.Medium"
                                       OnClick="@DarkModeToggle"
                                       AriaLabel="Alternar tema" />

                        <MudText Class="user-name">@GetDisplayName(auth.User)</MudText>

                        <MudMenu Dense Variant="Variant.Text"
                                 Size="Size.Medium"
                                 Color="Color.Inherit"
                                 Icon="@Icons.Material.TwoTone.MoreVert"
                                 AnchorOrigin="Origin.BottomRight"
                                 TransformOrigin="Origin.TopRight">

                            <MudMenu StartIcon="@Icons.Material.TwoTone.Settings"
                                     IconColor="Color.Primary"
                                     Label="Settings">
                                <MudMenuItem Icon="@Icons.Material.TwoTone.DarkMode"
                                             IconColor="Color.Secondary"
                                             OnClick="@DarkModeToggle"
                                             Label="Dark Theme" />
                            </MudMenu>

                            <MudDivider />

                            @if (auth.User.IsInRole("Candidate"))
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Work"
                                             Label="Minhas vagas"
                                             OnClick="@(() => Nav.NavigateTo("/candidato/home"))" />
                            }

                            @if (auth.User.IsInRole("Enterprise"))
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Dashboard"
                                             Label="Painel da empresa"
                                             OnClick="@(() => Nav.NavigateTo("/empresa/home"))" />
                            }

                            <MudDivider />

                            <MudMenuItem Icon="@Icons.Material.TwoTone.Logout"
                                         IconColor="Color.Error"
                                         Label="Sign Out"
                                         OnClick="Logout" />
                        </MudMenu>
                    </MudStack>
                </Authorized>
            </AuthorizeView>
        </MudContainer>
    </MudAppBar>

    <!-- MAIN -->
    <MudMainContent Class="app-main">
        <MudContainer MaxWidth="MaxWidth.Large" Class="app-main__container">
            @Body
        </MudContainer>
    </MudMainContent>

    <!-- FOOTER (não fixo; "gruda" no fim sem cobrir conteúdo) -->
    <footer class="app-footer">
        <MudContainer MaxWidth="MaxWidth.Large" Class="app-footer__inner">
            <div class="footer-left">© @DateTime.Now.Year Sarah Dine dos Santos Pereira</div>

            <div class="footer-right">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudLink Href="/termos">Termos</MudLink>
                    <MudLink Href="/privacidade">Privacidade</MudLink>
                    <MudLink Href="/contato">Contato</MudLink>
                </MudStack>
            </div>
        </MudContainer>
    </footer>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

<style>
    /* ---------- Shell para footer "sticky" sem overlap ---------- */
    .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--mud-palette-background);
    }

    .appbar {
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
        border-bottom: 1px solid var(--mud-palette-divider);
    }

    .appbar__inner {
        display: flex;
        align-items: center;
        gap: .5rem;
        min-height: 56px;
    }

    .brand {
        font-weight: 700;
        letter-spacing: .2px;
    }

    .user-name {
        font-size: .95rem;
        color: var(--mud-palette-text-secondary);
        margin-right: .25rem;
        max-width: 22ch;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Main ocupa o espaço restante para empurrar o footer */
    .app-main {
        flex: 1 0 auto;
        padding-top: 16px; /* respira sob a appbar */
        padding-bottom: 16px;
    }

    .app-main__container {
        padding-top: 8px;
        padding-bottom: 24px;
    }

    /* ---------- Footer elegante, não fixo ---------- */
    .app-footer {
        flex-shrink: 0; /* evita encolher */
        border-top: 1px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface);
    }

    .app-footer__inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 8px;
        gap: 12px;
    }

    .footer-left {
        font-size: .875rem;
        color: var(--mud-palette-text-secondary);
        white-space: nowrap;
    }

    .footer-right a {
        text-decoration: none;
    }

    /* ---------- Responsividade ---------- */
    @@media (max-width: 599px) {
        .appbar__inner, .app-footer__inner

    {
        padding-left: 12px;
        padding-right: 12px;
    }

    .user-name {
        display: none;
    }
    /* prioriza ações no mobile */
    }
</style>

@code {
    private bool _drawerOpen = false;
    private bool _isDarkMode = false;
    private MudTheme? _theme = null;

    private async Task Logout() => await Auth.LogoutAsync();

    private static string GetDisplayName(ClaimsPrincipal user)
        => user.FindFirst("nickname")?.Value
           ?? user.Identity?.Name
           ?? user.FindFirst(ClaimTypes.Email)?.Value
           ?? "Usuário";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _theme = new()
        {
            PaletteLight = _lightPalette,
            PaletteDark = _darkPalette,
            LayoutProperties = new LayoutProperties()
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && AuthStateProvider is JwtAuthenticationStateProvider jwt)
        {
            await jwt.RestoreAsync();
        }
    }

    private void DrawerToggle() => _drawerOpen = !_drawerOpen;
    private void DarkModeToggle() => _isDarkMode = !_isDarkMode;

    private readonly PaletteLight _lightPalette = new()
    {
        Primary = "#0a66c2",
        PrimaryDarken = "#004182",
        PrimaryLighten = "#e5f0fb",
        Secondary = "#0056a0",
        AppbarBackground = "#ffffff",
        AppbarText = "#2c2c2c",
        Background = "#f3f6f9",
        Surface = "#ffffff",
        DrawerBackground = "#ffffff",
        DrawerText = "#2c2c2c",
        DrawerIcon = "#0a66c2",
        TextPrimary = "#2c2c2c",
        TextSecondary = "#4a4a4a",
        ActionDefault = "#0a66c2",
        ActionDisabled = "#9e9e9e",
        ActionDisabledBackground = "#e0e0e0",
        LinesDefault = "#e0e0e0",
        TableLines = "#f0f0f0",
        Divider = "#e0e0e0",
        Success = "#2e7d32",
        Warning = "#ed6c02",
        Error = "#d32f2f",
        Info = "#0288d1",
    };

    private readonly PaletteDark _darkPalette = new()
    {
        Primary = "#0a66c2",
        PrimaryDarken = "#004182",
        PrimaryLighten = "#5b9bd5",
        Background = "#1a1a27",
        Surface = "#20202f",
        AppbarBackground = "#1a1a27",
        AppbarText = "#e0e0e0",
        DrawerBackground = "#1a1a27",
        DrawerText = "#e0e0e0",
        DrawerIcon = "#0a66c2",
        TextPrimary = "#ffffff",
        TextSecondary = "#c0c0c0",
        ActionDefault = "#0a66c2",
        ActionDisabled = "#9999994d",
        ActionDisabledBackground = "#605f6d4d",
        LinesDefault = "#2f2f2f",
        TableLines = "#3a3a3a",
        Divider = "#33323e",
        Success = "#3dcb6c",
        Warning = "#ffb545",
        Error = "#ff3f5f",
        Info = "#4a86ff",
        OverlayLight = "#1e1e2d80",
    };

    public string DarkLightModeButtonIcon => _isDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };
}
