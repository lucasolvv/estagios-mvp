@page "/empresa/home"
@using System.Security.Claims
@using PlataformaEstagio.Web.Components.Services.Enterprise
@using PlataformaEstagios.Communication.Responses
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject IUserContext CurrentUser

<AuthorizeView Context="auth" Roles="Enterprise">
    <MudContainer MaxWidth="MaxWidth.False" Class="px-6 py-3">

        <MudGrid>

            <!-- HERO / Ações rápidas -->
            <MudItem xs="12">
                <MudPaper Class="hero-card elev">
                    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="hero-inner">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.h5" Class="font-bold">
                                Olá, @((CurrentUser?.Nickname) ?? GetDisplayName(auth.User)) 👋
                            </MudText>
                            <MudText Typo="Typo.subtitle2" Class="text-dim">
                                Veja o resumo das suas vagas, candidatos e entrevistas.
                            </MudText>
                        </MudStack>

                        <MudStack Row Spacing="1">
                            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.AddBusiness" Color="Color.Primary" OnClick="OnCriarVaga">
                                Criar vaga
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ListAlt" OnClick="OnGerenciarVagas">
                                Gerenciar vagas
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Groups" OnClick="OnBancoTalentos">
                                Banco de talentos
                            </MudButton>
                            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Event" OnClick="OnConfigurarEntrevistas">
                                Entrevistas
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- COLUNA ESQUERDA -->
            <MudItem xs="12" md="8">

                <!-- Minhas vagas ativas -->
                <MudCard Class="elev mb-4">
                    <div class="card-header accent-primary">
                        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.WorkOutline" />
                                <MudText Typo="Typo.subtitle1">Minhas vagas ativas</MudText>
                            </MudStack>
                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small">
                                @ActiveJobs.Count @((ActiveJobs.Count == 1) ? "vaga" : "vagas")
                            </MudChip>
                        </MudStack>
                    </div>

                    <MudCardContent Class="pt-3">
                        @if (_isLoading)
                        {
                            <MudSkeleton Height="32px" Class="mb-2" />
                            <MudSkeleton Height="32px" Class="mb-2" />
                            <MudSkeleton Height="32px" />
                        }
                        else
                        {
                            <MudTable Items="ActiveJobs" Dense="true" Hover="true" Class="table-compact">
                                <HeaderContent>
                                    <MudTh>Título</MudTh>
                                    <MudTh>Abertura</MudTh>
                                    <MudTh>Inscritos</MudTh>
                                    <MudTh>Status</MudTh>
                                    <MudTh class="text-right">Ações</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd>@context.Titulo</MudTd>
                                    <MudTd>@context.DataAbertura.ToString("dd/MM/yyyy")</MudTd>
                                    <MudTd>@context.Inscritos</MudTd>
                                    <MudTd>
                                        <MudChip T="string" Color="@JobStatusColor(context.Status)" Variant="Variant.Filled" Size="Size.Small">
                                            @context.Status
                                        </MudChip>
                                    </MudTd>
                                    <MudTd Class="text-right">
                                        <MudTooltip Text="Editar vaga">
                                            <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined"
                                                       StartIcon="@Icons.Material.Filled.Edit" OnClick="@(()=>OnEditarVaga(context))">
                                                Editar
                                            </MudButton>
                                        </MudTooltip>
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                                        Nenhuma vaga ativa.
                                    </MudAlert>
                                </NoRecordsContent>
                            </MudTable>
                        }
                    </MudCardContent>
                </MudCard>

                <!-- Candidatos recentes -->
                <MudCard Class="elev">
                    <div class="card-header accent-info">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.PersonSearch" />
                            <MudText Typo="Typo.subtitle1">Candidatos recentes</MudText>
                        </MudStack>
                    </div>

                    <MudCardContent Class="pt-3">
                        <MudTable Items="RecentCandidates" Dense="true" Hover="true" Class="table-compact">
                            <HeaderContent>
                                <MudTh>Nome</MudTh>
                                <MudTh>Curso</MudTh>
                                <MudTh>Vaga</MudTh>
                                <MudTh>Status</MudTh>
                                <MudTh>Data</MudTh>
                                <MudTh class="text-right">Ações</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.NomeCandidato</MudTd>
                                <MudTd>@context.NomeCursoCandidato</MudTd>
                                <MudTd>@context.TituloVaga</MudTd>
                                <MudTd>
                                    <MudChip T="string" Color="@StatusColor(context.Status)" Variant="Variant.Filled" Size="Size.Small">
                                        @context.Status
                                    </MudChip>
                                </MudTd>
                                <MudTd>@context.DataCandidatura.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd Class="text-right">
                                    <MudButton Size="Size.Small" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ManageAccounts"
                                               OnClick="@(() => OnGerenciarCandidatura(context.idCandidatura, context.idCandidato))">
                                        Gerenciar
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                                    Sem novas inscrições.
                                </MudAlert>
                            </NoRecordsContent>
                        </MudTable>
                    </MudCardContent>
                </MudCard>

            </MudItem>

            <!-- COLUNA DIREITA -->
            <MudItem xs="12" md="4">

                <!-- Métricas rápidas (card único) -->
                <!-- Métricas rápidas (card único, compacto e alinhado) -->
                <MudCard Class="elev mb-4">
                    <div class="card-header accent-primary">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Insights" />
                            <MudText Typo="Typo.subtitle1">Resumo rápido</MudText>
                        </MudStack>
                    </div>

                    <MudCardContent class="kpi-inline-card">
                        <!-- KPIs em linha (quebra automática) -->
                        <div class="kpi-inline">
                            <div class="stat">
                                <div class="stat__label">
                                    <MudIcon Icon="@Icons.Material.Filled.WorkOutline" />
                                    <span>Vagas abertas</span>
                                </div>
                                <div class="stat__value">@ActiveJobs.Count</div>
                            </div>

                            <div class="divider-v" aria-hidden="true"></div>

                            <div class="stat">
                                <div class="stat__label">
                                    <MudIcon Icon="@Icons.Material.Filled.Inbox" />
                                    <span>Inscrições recebidas</span>
                                </div>
                                <div class="stat__value">@Stats.Inscricoes</div>
                            </div>

                            <div class="divider-v" aria-hidden="true"></div>

                            <div class="stat">
                                <div class="stat__label">
                                    <MudIcon Icon="@Icons.Material.Filled.Event" />
                                    <span>Entrevistas marcadas</span>
                                </div>
                                <div class="stat__value">@Stats.Entrevistas</div>
                            </div>
                        </div>

                        <MudDivider Class="my-2" />

                        <!-- Taxa de preenchimento -->
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Class="text-dim">Taxa de preenchimento</MudText>
                            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.h6">@Stats.TaxaPreenchimento.ToString("P0")</MudText>
                                <MudText Typo="Typo.caption" Class="text-dim">
                                    @(ActiveJobs.Count == 0 ? "—" : $"{Stats.Inscricoes} inscrições / {ActiveJobs.Count} vagas")
                                </MudText>
                            </MudStack>
                            <MudProgressLinear Value="@(Stats.TaxaPreenchimento * 100)" Color="Color.Info" Class="progress-tight" />
                        </MudStack>
                    </MudCardContent>

                </MudCard>



                <!-- Próximas entrevistas -->
                <MudCard Class="elev mb-4">
                    <div class="card-header accent-primary">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" />
                            <MudText Typo="Typo.subtitle1">Próximas entrevistas</MudText>
                        </MudStack>
                    </div>
                    <MudCardContent>
                        @if (UpcomingInterviews.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                                Sem entrevistas marcadas.
                            </MudAlert>
                        }
                        else
                        {
                            <MudList Dense="true" T="InterviewVm" Class="list-clean">
                                @foreach (var i in UpcomingInterviews)
                                {
                                    <MudListItem>
                                        <MudListItemIcon><MudIcon Icon="@Icons.Material.Filled.Event" /></MudListItemIcon>
                                        <MudListItemText>
                                            <div class="font-medium">@i.Candidato • @i.Vaga</div>
                                            <small class="text-dim">@i.Data.ToString("dd/MM HH:mm") • @i.Canal</small>
                                        </MudListItemText>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudCardContent>
                </MudCard>

                <!-- Notificações -->
                <MudCard Class="elev">
                    <div class="card-header accent-info">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Notifications" />
                            <MudText Typo="Typo.subtitle1">Notificações</MudText>
                        </MudStack>
                    </div>
                    <MudCardContent Class="timeline-clean">
                        @if (Notifications.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                                Sem novas notificações.
                            </MudAlert>
                        }
                        else
                        {
                            <MudTimeline>
                                @foreach (var n in Notifications)
                                {
                                    <MudTimelineItem>
                                        <div class="font-medium">@n.Texto</div>
                                        <small class="text-dim">@n.Data.ToString("dd/MM HH:mm")</small>
                                    </MudTimelineItem>
                                }
                            </MudTimeline>
                        }
                    </MudCardContent>
                </MudCard>

            </MudItem>
        </MudGrid>
    </MudContainer>
</AuthorizeView>

<style>
    /* Barra de acento por tipo de seção */
    .card-header.accent-primary::before {
        background: var(--mud-palette-primary);
    }

    .card-header.accent-info::before {
        background: var(--mud-palette-info);
    }

    .card-header.accent-success::before {
        background: var(--mud-palette-success);
    }

    .card-header.accent-warning::before {
        background: var(--mud-palette-warning);
    }

    .card-header.accent-error::before {
        background: var(--mud-palette-error);
    }

    /* container do card */
    .kpi-inline-card {
        padding-top: .6rem;
        padding-bottom: .8rem;
    }

    /* linha de KPIs: itens se ajustam e quebram sem cortar */
    .kpi-inline {
        display: flex;
        flex-wrap: wrap;
        align-items: stretch;
        gap: .75rem;
    }

    /* cada estatística ocupa espaço flexível e mínimo */
    .stat {
        flex: 1 1 190px; /* min ~190px, cresce até ocupar igualmente */
        display: grid;
        grid-template-rows: auto 1fr;
        padding: .25rem .2rem .25rem 0; /* sem “caixa” para ficar mais leve */
    }

    /* rótulo com ícone */
    .stat__label {
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        color: var(--mud-palette-text-secondary);
        font-size: .88rem;
    }

    /* valor com ênfase */
    .stat__value {
        font-weight: 800;
        font-size: 1.45rem;
        line-height: 1.1;
        margin-top: .15rem;
    }

    /* divisor vertical que some quando quebra linha */
    .divider-v {
        width: 1px;
        background: var(--mud-palette-divider);
        align-self: stretch;
    }
    @@media (max-width: 700px) {
        .divider-v

    {
        display: none;
    }
    /* evita divisores soltos em quebra de linha */
    }

    /* progress compacto */
    .progress-tight {
        margin-top: .25rem;
    }
</style>



@code {
    @inject IEnterpriseService _service

    private bool _isLoading = true;
    private Guid? _enterpriseId;
    private List<JobCompanyVm> ActiveJobs { get; set; } = new();
    private List<ApplicationVm> RecentCandidates { get; set; } = new();
    private List<InterviewVm> UpcomingInterviews { get; set; } = new();
    private StatsVm Stats { get; set; } = new(0, 0, 0, 0);

    private bool _hydrated;     
    private bool _loadingJobs; 

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hydrated && firstRender)
        {
            _hydrated = true;
            await CurrentUser.RefreshAsync();
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task LoadAsync()
    {
        if (_loadingJobs) return;   // trava reentrada
        _loadingJobs = true;
        _isLoading = true;

        try
        {
            if (CurrentUser.UserTypeId is Guid id)
            {
                var vagas = await _service.GetActiveAsync(id);
                ActiveJobs = vagas.Select(v => new JobCompanyVm(
                    v.VacancyIdentifier,
                    v.Title,
                    v.OpenedAt.ToLocalTime(),
                    v.Applicants,
                    v.Status)).ToList();

                var applications = await _service.GetAllApplicationsByEnterpriseIdAsync(id);
                RecentCandidates = applications
                    .OrderByDescending(a => a.DataCandidatura)
                    .Take(5)
                    .Select(a => new ApplicationVm(
                        a.NomeCandidato,
                        a.TituloVaga,
                        a.DataCandidatura,
                        a.NomeCurso,
                        a.CandidateIdentifier,
                        a.ApplicationIdentifier,
                        a.Status)
                    )
                    .ToList();

                // 1) busca entrevistas (pode vir null do service)
                var interviews = await _service.GetAllInterviewsByEnterpriseIdAsync(id)
                                 ?? Array.Empty<ResponseGetInterviewItemJson>();

                // 2) índice das candidaturas (se a lista estiver vazia, vira dicionário vazio)
                var appsById = RecentCandidates?.ToDictionary(a => a.idCandidatura, a => a)
                              ?? new Dictionary<Guid, ApplicationVm>();

                // 3) monta os cards; se não achar candidatura correspondente, usa "—"
                UpcomingInterviews = interviews
                    .Where(i => i.StartAt > DateTimeOffset.UtcNow)
                    .OrderBy(i => i.StartAt)
                    .Take(5)
                    .Select(i =>
                    {
                        appsById.TryGetValue(i.ApplicationIdentifier, out var app);
                        var candidato = app?.NomeCandidato ?? "—";
                        var vaga = app?.TituloVaga ?? "—";
                        var canal = ChannelLabel(i.Location, i.MeetingLink);

                        return new InterviewVm(
                            candidato,
                            vaga,
                            i.StartAt.LocalDateTime,   // <- melhor que .Date.ToLocalTime()
                            canal
                        );
                    })
                    .ToList();

                // 4) métricas (interviews pode ser vazio)
                Stats = new StatsVm(
                    VagasAbertas: ActiveJobs.Count,
                    Inscricoes: applications.Count,
                    Entrevistas: interviews.Count(),
                    TaxaPreenchimento: ActiveJobs.Count == 0 ? 0 :
                        (double)applications.Count(a => a.Status == "Approved") / ActiveJobs.Count
                );

            }
            else
            {
                Snackbar.Add("ID da empresa não encontrado nas claims.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Falha ao carregar vagas: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            _loadingJobs = false;
            // segura o render no fim do ciclo atual
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string ChannelLabel(string? location, string? link)
    {
        if (!string.IsNullOrWhiteSpace(link))
        {
            var l = link.ToLowerInvariant();
            if (l.Contains("meet.google")) return "Google Meet";
            if (l.Contains("teams.microsoft")) return "Microsoft Teams";
            return "Online";
        }
        return string.IsNullOrWhiteSpace(location) ? "—" : location;
    }

    private static string GetDisplayName(ClaimsPrincipal user)
        => user.FindFirst("nickname")?.Value
           ?? user.Identity?.Name
           ?? user.FindFirst(ClaimTypes.Email)?.Value
           ?? "Empresa";

    private void OnCriarVaga() => Nav.NavigateTo("/empresa/vagas/nova");
    private void OnGerenciarVagas() => Snackbar.Add("Gerenciar vagas (TODO)", Severity.Info);
    private void OnBancoTalentos() => Snackbar.Add("Banco de talentos (TODO)", Severity.Info);
    private void OnConfigurarEntrevistas() => Snackbar.Add("Configurar entrevistas (TODO)", Severity.Info);

    private void OnEditarVaga(JobCompanyVm job) => Nav.NavigateTo($"/empresa/vagas/{job.JobId}/editar");
    private void OnGerenciarCandidatura(Guid applicationId, Guid candidateId) => Nav.NavigateTo($"/empresa/candidatura/gerenciar/{applicationId}/{candidateId}");
    private void OnAgendarEntrevista(CandidateVm c) => Snackbar.Add($"Agendar entrevista com {c.Nome} (mock).", Severity.Success);

    private Color JobStatusColor(string status) => status switch
    {
        "Ativa" => Color.Success,
        "Encerrada" => Color.Error,
        _ => Color.Warning
    };

    // --- VMs (mocks à direita e métricas)
    private record StatsVm(int VagasAbertas, int Inscricoes, int Entrevistas, double TaxaPreenchimento);
    private record JobCompanyVm(Guid JobId, string Titulo, DateTime DataAbertura, int Inscritos, string Status);
    private record CandidateVm(string Nome, string Curso, string Vaga, DateTime Data);
    private record InterviewVm(string Candidato, string Vaga, DateTime Data, string Canal);
    private record ApplicationVm(string NomeCandidato, string TituloVaga, DateTime DataCandidatura, string NomeCursoCandidato, Guid idCandidato, Guid idCandidatura, string Status);
    private record NotificationVm(string Texto, DateTime Data);

    private List<NotificationVm> Notifications = new()
    {
        new("Novo candidato em 'Frontend (Blazor)': Ana Souza", DateTime.Today.AddHours(-3)),
        new("Bruno Lima confirmou entrevista para amanhã", DateTime.Today.AddHours(-6))
    };

    private Color StatusColor(string status) => status switch
    {
        "Approved" => Color.Success,
        "Pending" => Color.Warning,
        "Rejected" => Color.Error,
        _ => Color.Warning
    };
}
